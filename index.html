<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>익명 1:1 채팅</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html, body { height: 100%; }
    .scrollbar-thin::-webkit-scrollbar { height: 6px; width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 8px; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-900">
  <div class="max-w-md mx-auto px-4 py-8">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">익명 1:1 채팅</h1>
      <span id="authBadge" class="text-xs text-slate-500" title="">연결 준비중...</span>
    </header>

    <!-- 홈 화면 -->
    <section id="home" class="rounded-2xl bg-white shadow p-6 hidden">
      <h2 class="text-lg font-semibold mb-2">랜덤 익명 매칭</h2>
      <p class="text-slate-600 mb-4">아래 중 원하는 방식으로 시작하세요.</p>

      <!-- 자동 매칭 -->
      <div id="idleActions" class="space-y-3">
        <button id="btnStart" class="w-full py-3 rounded-xl bg-emerald-600 text-white font-semibold">
          익명 채팅 시작하기 (자동 매칭)
        </button>
      </div>

      <!-- 매칭중 -->
      <div id="matching" class="hidden flex flex-col items-center justify-center gap-3 py-8">
        <div class="animate-spin w-8 h-8 border-4 border-slate-200 border-t-indigo-600 rounded-full"></div>
        <p class="text-sm text-slate-700">채팅자 찾는중..</p>
        <button id="btnCancel" class="px-4 py-2 rounded-lg bg-slate-200 text-slate-800 text-sm">취소</button>
      </div>

      <!-- 수동 모드 (방 코드) -->
      <div class="mt-6 border-t pt-4 space-y-2">
        <h3 class="text-sm font-semibold text-slate-600">수동 입장 (방 코드 공유)</h3>
        <button id="btnHostManual" class="w-full py-2 rounded-lg bg-slate-800 text-white text-sm">호스트 방 만들기</button>

        <div class="flex gap-2">
          <input id="roomCodeInput" class="flex-1 px-3 py-2 rounded-lg border" placeholder="방 코드 입력(문서 ID)" />
          <button id="btnJoinManual" class="px-4 py-2 rounded-lg bg-indigo-600 text-white text-sm">게스트 입장</button>
        </div>

        <div id="shareHint" class="hidden text-xs text-slate-600 bg-slate-100 rounded-lg p-2">
          내 방 코드: <b id="roomCodeText"></b>
          <button id="btnCopyCode" class="ml-2 px-2 py-0.5 rounded bg-slate-300 text-slate-800">복사</button>
          <span class="ml-1 text-[11px] text-slate-500">(친구가 위 코드를 입력하면 연결됩니다)</span>
        </div>
      </div>

      <!-- 디버그 -->
      <details class="mt-4 text-sm text-slate-500">
        <summary class="cursor-pointer">연결 상태</summary>
        <div class="mt-2 space-y-1">
          <div>내 UID: <span id="dbgUid">-</span></div>
          <div>룸 ID: <span id="dbgRoom">-</span></div>
          <div>역할: <span id="dbgRole">-</span></div>
        </div>
      </details>
    </section>

    <!-- 채팅 화면 -->
    <section id="chat" class="hidden rounded-2xl bg-white shadow flex flex-col h-[70vh] mt-6">
      <div class="flex items-center justify-between p-4 border-b">
        <div>
          <div class="text-sm text-slate-500">상대와 익명 채팅</div>
          <div id="nickbar" class="font-semibold"></div>
        </div>
        <button id="btnLeave" class="px-3 py-2 rounded-lg bg-slate-200 text-sm">나가기</button>
      </div>

      <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2 scrollbar-thin bg-slate-50"></div>

      <form id="messageForm" class="p-3 border-t flex gap-2">
        <input id="messageInput" class="flex-1 px-3 py-2 rounded-lg border" placeholder="메시지를 입력..." autocomplete="off" />
        <button class="px-4 py-2 rounded-lg bg-indigo-600 text-white">전송</button>
      </form>
    </section>
  </div>

  <!-- Firebase SDK (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <script>
    // === 1) Firebase 초기화 ===
    const firebaseConfig = {
      apiKey: "AIzaSyACfmI0SvAFEEjlFTkkoI1leGoZ-IYj9iI",
      authDomain: "eekmyoung-b85f9.firebaseapp.com",
      projectId: "eekmyoung-b85f9",
      storageBucket: "eekmyoung-b85f9.appspot.com",
      messagingSenderId: "576568352493",
      appId: "1:576568352493:web:57784642885f24115576e4",
      measurementId: "G-ZQYHMN5BBL"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // === 2) 익명 로그인 ===
    auth.signInAnonymously().catch(console.error);

    // === DOM 요소 ===
    const authBadge = document.getElementById('authBadge');
    const home = document.getElementById('home');
    const matchingBox = document.getElementById('matching');
    const btnStart = document.getElementById('btnStart');
    const btnCancel = document.getElementById('btnCancel');
    const btnLeave = document.getElementById('btnLeave');
    const dbgUid = document.getElementById('dbgUid');
    const dbgRoom = document.getElementById('dbgRoom');
    const dbgRole = document.getElementById('dbgRole');
    const chatSec = document.getElementById('chat');
    const nickbar = document.getElementById('nickbar');
    const messages = document.getElementById('messages');
    const form = document.getElementById('messageForm');
    const input = document.getElementById('messageInput');

    // 수동 모드 DOM
    const btnHostManual = document.getElementById('btnHostManual');
    const btnJoinManual = document.getElementById('btnJoinManual');
    const roomCodeInput = document.getElementById('roomCodeInput');
    const shareHint = document.getElementById('shareHint');
    const roomCodeText = document.getElementById('roomCodeText');
    const btnCopyCode = document.getElementById('btnCopyCode');

    // === 상태 ===
    let currentUser = null;
    let currentRoomId = null;
    let currentRole = null;   // 'host' | 'guest'
    let roomUnsub = null;
    let msgUnsub = null;

    const ADJ = ['푸른','은하','순수','초록','고요','깊은','맑은','번쩍','은빛','따뜻'];
    const ANM = ['여우','수달','돌고래','펭귄','고래','고양이','사자','부엉이','라쿤','두더지'];
    const pickNick = () => `${ADJ[Math.floor(Math.random()*ADJ.length)]} ${ANM[Math.floor(Math.random()*ANM.length)]}`;

    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');
    const setDebug = () => {
      dbgUid.textContent = currentUser?.uid || '-';
      dbgRoom.textContent = currentRoomId || '-';
      dbgRole.textContent = currentRole || '-';
    };

    auth.onAuthStateChanged(user => {
      currentUser = user || null;
      if (user) {
        authBadge.textContent = '익명 접속 완료';
        authBadge.title = `projectId: ${firebase.app().options.projectId}`;
        show(home);
      }
      setDebug();
    });

    // === 자동 매칭 (경합 내성 + 백오프 재시도) ===
    async function startMatching() {
      if (!currentUser) return;
      hide(document.getElementById('idleActions'));
      show(matchingBox);

      const tryJoinOnce = async () => {
        const snap = await db.collection('rooms')
          .where('open','==',true)
          .limit(5)
          .get();

        for (const d of snap.docs) {
          const ref = d.ref;
          try {
            await db.runTransaction(async tx => {
              const s = await tx.get(ref);
              if (!s.exists) throw new Error('gone');
              const room = s.data();
              if (!room.open) throw new Error('closed');
              if (room.host === currentUser.uid) throw new Error('self');

              const nickG = pickNick();
              const nickH = room.nicks?.host || pickNick();
              tx.update(ref, {
                guest: currentUser.uid,
                open: false,
                nicks: { host: nickH, guest: nickG }
              });
            });
            currentRoomId = ref.id;
            currentRole = 'guest';
            enterRoomUI();
            return true;
          } catch (e) {
            // 다음 열린 방 시도
          }
        }
        return false;
      };

      for (let i = 0; i < 3; i++) {
        const ok = await tryJoinOnce();
        if (ok) return;
        await new Promise(r => setTimeout(r, 200 + i * 200));
      }

      // 실패 → 내가 host로 대기
      const nickH = pickNick();
      const roomDoc = await db.collection('rooms').add({
        open: true,
        host: currentUser.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        nicks: { host: nickH }
      });
      currentRoomId = roomDoc.id;
      currentRole = 'host';
      setDebug();

      if (roomUnsub) roomUnsub();
      roomUnsub = roomDoc.onSnapshot(snap => {
        const d = snap.data();
        if (d?.guest && d.open === false) {
          enterRoomUI();
        }
      });
    }

    // === 수동: 호스트 방 만들기 (코드 공유) ===
    async function createHostRoomManual() {
      if (!currentUser) return;
      hide(document.getElementById('idleActions'));
      show(matchingBox);

      const nickH = pickNick();
      const roomDoc = await db.collection('rooms').add({
        open: true,
        host: currentUser.uid,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        nicks: { host: nickH }
      });

      currentRoomId = roomDoc.id;
      currentRole   = 'host';
      setDebug();

      // 방 코드 표시 + 복사 버튼 활성화
      roomCodeText.textContent = currentRoomId;
      shareHint.classList.remove('hidden');

      if (roomUnsub) roomUnsub();
      roomUnsub = roomDoc.onSnapshot(snap => {
        const d = snap.data();
        if (d?.guest && d.open === false) {
          shareHint.classList.add('hidden');
          enterRoomUI();
        }
      });
    }

    // === 수동: 방 코드로 게스트 입장 ===
    async function joinAsGuestWithCode() {
      if (!currentUser) return;
      const code = roomCodeInput.value.trim();
      if (!code) { alert('방 코드를 입력해 주세요.'); return; }

      hide(document.getElementById('idleActions'));
      show(matchingBox);

      const ref = db.collection('rooms').doc(code);
      try {
        await db.runTransaction(async tx => {
          const s = await tx.get(ref);
          if (!s.exists) throw new Error('NOT_FOUND');
          const room = s.data();

          if (room.host === currentUser.uid) throw new Error('SELF_JOIN');
          if (!room.open) throw new Error('CLOSED');

          const nickG = pickNick();
          const nickH = room.nicks?.host || pickNick();
          tx.update(ref, {
            guest: currentUser.uid,
            open: false,
            nicks: { host: nickH, guest: nickG }
          });
        });

        currentRoomId = code;
        currentRole   = 'guest';
        setDebug();
        enterRoomUI();
      } catch (e) {
        show(document.getElementById('idleActions'));
        hide(matchingBox);
        const map = {
          NOT_FOUND:'방을 찾을 수 없어요.',
          SELF_JOIN:'자신의 방에는 게스트로 입장할 수 없어요.',
          CLOSED:'이미 매칭이 완료된 방이에요.'
        };
        alert(map[e.message] || '입장에 실패했어요. 코드와 상태를 확인해 주세요.');
      }
    }

    function enterRoomUI() {
      hide(matchingBox);
      show(chatSec);
      const roomRef = db.collection('rooms').doc(currentRoomId);

      roomRef.get().then(s => {
        const d = s.data();
        const myNick = currentRole === 'host' ? d.nicks.host : d.nicks.guest;
        const otherNick = currentRole === 'host' ? d.nicks.guest : d.nicks.host;
        nickbar.textContent = `${myNick} • 상대: ${otherNick || '대기중...'}`;
      });

      if (msgUnsub) msgUnsub();
      msgUnsub = roomRef.collection('messages')
        .orderBy('createdAt', 'asc')
        .onSnapshot(snap => {
          messages.innerHTML = '';
          snap.forEach(doc => {
            const m = doc.data();
            const isMe = m.uid === currentUser.uid;
            const wrap = document.createElement('div');
            wrap.className = `flex ${isMe ? 'justify-end' : ''}`;
            wrap.innerHTML =
              `<div class="max-w-[80%] px-3 py-2 rounded-xl ${isMe ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-900'}">${m.text}</div>`;
            messages.appendChild(wrap);
          });
          messages.scrollTop = messages.scrollHeight;
        });
    }

    async function cancelMatching() {
      // 열린 자기 방은 정리
      if (currentRole === 'host' && currentRoomId) {
        const ref = db.collection('rooms').doc(currentRoomId);
        const snap = await ref.get();
        if (snap.exists && snap.data().open && !snap.data().guest) {
          await ref.delete().catch(()=>{});
        }
      }
      currentRoomId = null; currentRole = null;
      if (roomUnsub) { roomUnsub(); roomUnsub = null; }
      hide(matchingBox);
      show(document.getElementById('idleActions'));
      shareHint.classList.add('hidden');
      setDebug();
    }

    async function leaveRoom(navigateHome = true) {
      if (msgUnsub) { msgUnsub(); msgUnsub = null; }
      if (roomUnsub) { roomUnsub(); roomUnsub = null; }
      currentRoomId = null; currentRole = null;
      hide(chatSec);
      if (navigateHome) { show(home); show(document.getElementById('idleActions')); }
      messages.innerHTML = '';
      setDebug();
    }

    async function sendMessage(text) {
      if (!text || !currentRoomId) return;
      await db.collection('rooms').doc(currentRoomId).collection('messages')
        .add({
          uid: currentUser.uid,
          text,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
    }

    // 이벤트 바인딩
    btnStart.addEventListener('click', startMatching);
    btnCancel.addEventListener('click', cancelMatching);
    btnLeave.addEventListener('click', () => leaveRoom(true));
    form.addEventListener('submit', e => {
      e.preventDefault();
      const t = input.value.trim();
      if (!t) return;
      sendMessage(t);
      input.value = '';
    });

    btnHostManual.addEventListener('click', createHostRoomManual);
    btnJoinManual.addEventListener('click', joinAsGuestWithCode);
    btnCopyCode.addEventListener('click', async () => {
      const code = roomCodeText.textContent.trim();
      if (!code) return;
      try { await navigator.clipboard.writeText(code); btnCopyCode.textContent='복사됨'; setTimeout(()=>btnCopyCode.textContent='복사',1000); }
      catch { alert('복사 실패! 코드를 직접 선택해 복사해 주세요.'); }
    });

    // 탭 닫기 시 열린 방 정리 (best-effort)
    window.addEventListener('beforeunload', () => {
      if (currentRole === 'host' && currentRoomId) {
        const ref = db.collection('rooms').doc(currentRoomId);
        ref.get().then(s=>{
          if (s.exists && s.data().open && !s.data().guest) {
            ref.delete().catch(()=>{});
          }
        });
      }
    });
  </script>
</body>
</html>
